<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">
	<title>Account Form</title>
	<link href="tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
<div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6">
	<div class="text-center py-4" id="loading">Loading...</div>
	<form class="space-y-4 hidden" id="accountForm">
		<!-- Form will be dynamically populated here -->
	</form>
</div>

<script>

	//curl -X GET 'https://example.com/api/index.php/v1/customtables/edit?layout=APIEdit&listing_id=4' -H 'Authorization: Bearer ebhT53Lr3NNInojXAVwJSyda8lYoFP1f' -H 'X-API-Key: YOUR_API_KEY'

	const API_BASE = 'https://example.com/';
	const API_KEY = 'YOUR_API_KEY_SET_IN_WEBSERVICES_PLUGIN';
	const TOKEN = 'TOKEN_GENERATED_BY_LOGIN_REQUEST';
	const LAYOUT = 'EditLayout';

	async function fetchFormData() {
		const headers = {
			'Authorization': 'Bearer ' + TOKEN,
			'X-API-Key': API_KEY
		};

		try {
			const response = await fetch(`${API_BASE}api/index.php/v1/customtables/edit?layout=${LAYOUT}`, {headers});
			return await response.json();
		} catch (error) {
			console.error('Error fetching form data:', error);
			return null;
		}
	}

	function createFormField(field, input_prefix) {

		const div = document.createElement('div');
		div.className = 'space-y-2';

		const label = document.createElement('label');
		label.className = 'block text-sm font-medium text-gray-700';
		label.htmlFor = field.fieldname;
		label.textContent = field.label;

		let input;

		if (field.input.type === 'lookuptable') {
			if (field.input.cascade) {
				const cascadeContainer = document.createElement('div');
				cascadeContainer.className = 'space-y-2';

				// Create dropdowns for each cascade level
				field.input.cascade.forEach((level, index) => {
					const select = document.createElement('select');
					select.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500';

					select.id = `${field.fieldname}_level${level.level}`;

					if (parseInt(level.level) === field.input.cascade.length)
						select.name = `${input_prefix}${field.fieldname}`;

					// Add empty option
					const emptyOption = document.createElement('option');
					emptyOption.value = '';
					emptyOption.textContent = `- Select ${level.table} -`;
					select.appendChild(emptyOption);

					// Add options if available
					if (level.options) {
						// Create document fragment for better performance
						const fragment = document.createDocumentFragment();

						level.options.forEach(option => {
							const opt = document.createElement('option');
							opt.value = option.value;
							opt.textContent = option.label;
							if (option.children) {
								opt.dataset.childrenUrl = option.children;
							}
							if (option.selected) {
								opt.selected = true;
							}
							fragment.appendChild(opt);
						});

						select.appendChild(fragment);
					}

					// Single event listener for the select element
					select.addEventListener('change', async (e) => {
						const selectedOption = e.target.options[e.target.selectedIndex];
						const childrenUrl = selectedOption.dataset.childrenUrl;

						if (childrenUrl) {
							try {
								const response = await fetch(API_BASE + childrenUrl, {
									headers: {
										'Authorization': 'Bearer ' + TOKEN,
										'X-API-Key': API_KEY
									}
								});
								const data = await response.json();

								console.warn("data:", data);

								const nextSelect = document.getElementById(`${field.fieldname}_level${level.level + 1}`);
								if (nextSelect) {
									// Use document fragment for better performance
									const fragment = document.createDocumentFragment();

									if (data.success) {
										// Add empty option
										const emptyOpt = document.createElement('option');
										emptyOpt.value = '';
										emptyOpt.textContent = '- Select -';
										fragment.appendChild(emptyOpt);

										// Add new options
										data.data.forEach(item => {
											const newOpt = document.createElement('option');
											newOpt.value = item.value;
											newOpt.textContent = item.label;
											fragment.appendChild(newOpt);
										});

										nextSelect.innerHTML = '';
										nextSelect.appendChild(fragment);
									} else {
										//Session (token) expired for example
										const emptyOpt = document.createElement('option');
										emptyOpt.value = '';
										emptyOpt.textContent = data.message;
										fragment.appendChild(emptyOpt);

										nextSelect.innerHTML = '';
										nextSelect.appendChild(fragment);
									}
								}
							} catch (error) {
								console.error('Error fetching cascade options:', error);
							}
						}
					});

					cascadeContainer.appendChild(select);
				});

				input = cascadeContainer;
			} else {
				// Regular select for non-cascade lookuptable
				input = document.createElement('select');
				input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500';

				const emptyOption = document.createElement('option');
				emptyOption.value = '';
				emptyOption.textContent = '- Select -';
				input.appendChild(emptyOption);

				if (field.input.options && field.input.options[0]?.options) {
					field.input.options[0].options.forEach(option => {
						const opt = document.createElement('option');
						opt.value = option.value;
						opt.textContent = option.label;
						if (option.selected) {
							opt.selected = true;
						}
						input.appendChild(opt);
					});
				}

				input.id = input_prefix + field.fieldname;
				input.name = input_prefix + field.fieldname;
				input.required = field.input.required;
			}
		} else {

			switch (field.input.renderAs) {

				case 'select':
					input = document.createElement('select');
					input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500';

					// Add empty option
					const emptyOption = document.createElement('option');
					emptyOption.value = '';
					emptyOption.textContent = '- Select -';
					input.appendChild(emptyOption);

					// Add options from the API
					if (field.input.options && field.input.options[0]?.options) {
						field.input.options[0].options.forEach(option => {
							const opt = document.createElement('option');
							//console.log("option:",option)
							opt.value = option.value;
							opt.textContent = option.label;
							if (option.selected) {
								opt.selected = true;
							}
							input.appendChild(opt);
						});
					}

					input.id = input_prefix + field.fieldname;
					input.name = input_prefix + field.fieldname;
					input.required = field.input.required;
					break;

				default: // text input
					input = document.createElement('input');
					input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500';
					input.type = field.input.renderAs; // Use renderAs directly as HTML input type
					input.value = field.input.value || '';

					input.id = input_prefix + field.fieldname;
					input.name = input_prefix + field.fieldname;
					input.required = field.input.required;
			}

		}

		div.appendChild(label);
		div.appendChild(input);

		return div;
	}

	async function initForm() {
		const dataReceived = await fetchFormData();

		console.log("dataReceived:", dataReceived)

		const input_prefix = dataReceived.input_prefix;
		const form_token = dataReceived.form_token;
		const formData = dataReceived.data;
		const id = dataReceived.id;
		if (!formData) {
			document.getElementById('loading').textContent = 'Error loading form data';
			return;
		}

		const form = document.getElementById('accountForm');
		const loadingDiv = document.getElementById('loading');

		// Create and append form fields
		formData.fields.forEach(field => {
			form.appendChild(createFormField(field, input_prefix));
		});

		// Add submit button
		const submitDiv = document.createElement('div');
		submitDiv.className = 'pt-4';
		const submitButton = document.createElement('button');
		submitButton.type = 'submit';
		submitButton.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline';
		submitButton.textContent = 'Save';
		submitDiv.appendChild(submitButton);
		form.appendChild(submitDiv);

		// Add form submit handler
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formValues = Object.fromEntries(new FormData(form));
			// Here you would typically send the form data back to the server
		});

		// Show form and hide loading message
		loadingDiv.classList.add('hidden');
		form.classList.remove('hidden');

		// Modify your form submit handler
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			// Show loading state
			const submitButton = form.querySelector('button[type="submit"]');
			const originalButtonText = submitButton.textContent;
			submitButton.disabled = true;
			submitButton.textContent = 'Saving...';

			try {
				// Get all form data
				const formData = new FormData(form);

				// Filter only fields that start with 'comes_', input_prefix set in the table settings
				const filteredFormValues = {};
				for (const [key, value] of formData.entries()) {
					if (key.startsWith(input_prefix)) {
						filteredFormValues[key] = value;
					}
				}

				filteredFormValues['1'] = form_token;
				filteredFormValues['task'] = 'save';
				filteredFormValues['id'] = id;

				console.warn("Filtered form data:", filteredFormValues);


				// Make the API call
				const response = await fetch(`${API_BASE}api/index.php/v1/customtables/edit?layout=${LAYOUT}`, {
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + TOKEN,
						'X-API-Key': API_KEY,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(filteredFormValues)
				});

				console.warn("response:", response);
				const result = await response.json();
				console.warn("result:", result);

				if (!response.ok) {
					throw new Error(result.message || 'Submission failed');
				}

				// Show success message
				const successMessage = document.createElement('div');
				successMessage.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mt-4';
				successMessage.textContent = 'Form submitted successfully!';
				form.appendChild(successMessage);

				// Remove success message after 3 seconds
				setTimeout(() => {
					successMessage.remove();
				}, 3000);

			} catch (error) {
				// Show error message
				const errorMessage = document.createElement('div');
				errorMessage.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4';
				errorMessage.textContent = error.message || 'An error occurred while submitting the form';
				form.appendChild(errorMessage);

				// Remove error message after 3 seconds
				setTimeout(() => {
					errorMessage.remove();
				}, 3000);

				console.error('Submission error:', error);
			} finally {
				// Reset button state
				submitButton.disabled = false;
				submitButton.textContent = originalButtonText;
			}
		});
	}

	// Initialize the form when the page loads
	document.addEventListener('DOMContentLoaded', initForm);

</script>
</body>
</html>