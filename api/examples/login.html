<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">
	<title>CustomTables Authentication Example</title>
	<link href="tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">
<div class="max-w-md w-full mx-4">
	<div class="bg-white p-8 rounded-lg shadow-md" id="loginForm">
		<h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
		<form class="space-y-4" id="authForm" onsubmit="handleLogin(event)">
			<div>
				<label class="block text-gray-700 mb-2">Username</label>
				<input class="w-full p-2 border rounded" id="username" required type="text">
			</div>
			<div>
				<label class="block text-gray-700 mb-2">Password</label>
				<input class="w-full p-2 border rounded" id="password" required type="password">
			</div>
			<button class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600" type="submit">
				Login
			</button>
		</form>
		<div class="mt-4 text-red-500 text-center hidden" id="errorMessage"></div>
	</div>

	<div class="bg-white p-8 rounded-lg shadow-md hidden" id="protectedContent">
		<div class="flex justify-between items-center mb-6">
			<h2 class="text-2xl font-bold">Welcome <span id="userName"></span></h2>
			<button class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" onclick="handleLogout()">
				Logout
			</button>
		</div>
		<div class="space-y-2" id="userInfo">
			<p>Email: <span id="userEmail"></span></p>
			<p>User ID: <span id="userId"></span></p>
			<p>Token: <span id="token"></span></p>
		</div>
	</div>
</div>

<script>

	//curl -X GET https://example.com/api/index.php/v1/customtables/login -H 'Content-Type: application/json' -d '{ "username": "",  "password": ""}' -H 'X-API-Key: YOUR_API_KEY'

	const API_BASE = 'https://example.com/';
	const API_KEY = 'YOUR_API_KEY_SET_IN_WEBSERVICES_PLUGIN';

	async function handleLogin(event) {
		event.preventDefault();

		const username = document.getElementById('username').value;
		const password = document.getElementById('password').value;

		const errorDiv = document.getElementById('errorMessage');
		errorDiv.classList.add('hidden');

		try {
			const loginResponse = await fetch(`${API_BASE}api/v1/customtables/login`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-API-Key': API_KEY
				},
				body: JSON.stringify({
					username: username,
					password: password
				})
			});

			const result = await loginResponse.json();

			if (result.success) {
				// Store the token and user data
				localStorage.setItem('access_token', result.data.access_token);
				localStorage.setItem('user', JSON.stringify(result.data.user));

				showProtectedContent(result.data.user);
			} else {
				throw new Error(result.message || 'Login failed');
			}
		} catch (error) {
			console.error('Login error:', error);
			errorDiv.textContent = error.message || 'Login failed. Please check your credentials.';
			errorDiv.classList.remove('hidden');
		}
	}

	function handleLogout() {
		localStorage.removeItem('access_token');
		localStorage.removeItem('user');
		document.getElementById('protectedContent').classList.add('hidden');
		document.getElementById('loginForm').classList.remove('hidden');
		document.getElementById('errorMessage').classList.add('hidden');
		document.getElementById('authForm').reset();
	}

	async function validateEmail() {
		const token = localStorage.getItem('access_token');
		if (!token) return false;

		try {
			const response = await fetch(`${API_BASE}/user/email`, {
				headers: {
					'Authorization': `Bearer ${token}`
				}
			});

			const result = await response.json();
			return result.success;
		} catch {
			return false;
		}
	}

	function showProtectedContent(userData) {

		const token = localStorage.getItem('access_token');

		document.getElementById('loginForm').classList.add('hidden');
		document.getElementById('protectedContent').classList.remove('hidden');
		document.getElementById('userName').textContent = userData.name;
		document.getElementById('userEmail').textContent = userData.email;
		document.getElementById('userId').textContent = userData.id;
		document.getElementById('token').textContent = token;
	}

	// Check login status when page loads
	document.addEventListener('DOMContentLoaded', async () => {
		const token = localStorage.getItem('access_token');
		const user = localStorage.getItem('user');

		if (!token || !user) {
			document.getElementById('loginForm').classList.remove('hidden');
			return;
		}

		// Validate token is still valid using email endpoint
		const isValid = await validateEmail();
		if (isValid) {
			showProtectedContent(JSON.parse(user));
		} else {
			localStorage.removeItem('access_token');
			localStorage.removeItem('user');
			document.getElementById('loginForm').classList.remove('hidden');
		}
	});
</script>
</body>
</html>
